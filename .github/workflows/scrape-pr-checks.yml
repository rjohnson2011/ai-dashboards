name: Scrape PR Checks

on:
  schedule:
    # Run every 30 minutes during business hours (9 AM - 7 PM EST, Monday-Friday)
    # Note: GitHub Actions uses UTC time. EST is UTC-5 (or UTC-4 during daylight saving)
    # 9 AM - 7 PM EST = 2 PM - 12 AM UTC (Standard Time)
    # 9 AM - 7 PM EDT = 1 PM - 11 PM UTC (Daylight Saving Time)
    # Using EDT schedule (more conservative, covers both):
    - cron: '0,30 13-22 * * 1-5'  # Every 30 min, 1 PM - 11 PM UTC, Mon-Fri
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.3.0'
        bundler-cache: true
    
    - name: Install dependencies
      run: |
        bundle install
        # Install Chrome for Selenium if needed
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
    
    - name: Run PR checks scraper
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        GITHUB_OWNER: ${{ secrets.GITHUB_OWNER }}
        GITHUB_REPO: ${{ secrets.GITHUB_REPO }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        RAILS_ENV: production
        RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      run: |
        echo "Starting PR checks scrape at $(date)"
        bundle exec rails runner scripts/github_actions_scraper.rb
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: scraper-logs
        path: log/production.log
        retention-days: 7